// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // CRITICAL: Always keep provider as "postgresql" - changing to "sqlite" breaks Vercel deployments
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// RBAC Models (using String fields instead of enums for SQLite compatibility)
model User {
  id               String        @id @default(cuid())
  email            String        @unique
  name             String?
  password         String? // Store hashed passwords
  globalRole       String        @default("USER") // "USER" | "SUPERUSER"
  defaultSurgeryId String?
  defaultSurgery   Surgery?      @relation("DefaultSurgery", fields: [defaultSurgeryId], references: [id])
  memberships      UserSurgery[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Test user fields
  isTestUser        Boolean @default(false)
  symptomUsageLimit Int? // null = unlimited, number = limit
  symptomsUsed      Int     @default(0)

  // Clinical review relationships
  clinicalReviews       Surgery[]             @relation("ClinicalReviews")
  symptomReviewStatuses SymptomReviewStatus[]

  // Feature flags
  userFeatureFlags UserFeatureFlag[]

  // Admin Toolkit
  adminItemEditors AdminItemEditor[]
  adminItemOwnership AdminItem[] @relation("AdminItemOwner")
  adminToolkitHistory AdminHistory[] @relation("AdminToolkitHistoryActor")

  // Workflow instances
  workflowInstances WorkflowInstance[]

  // Workflow governance
  workflowApprovals WorkflowTemplate[] @relation("WorkflowApprovals")
  workflowEdits     WorkflowTemplate[] @relation("WorkflowEdits")

  // NextAuth.js fields
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
}

model UserSurgery {
  id        String  @id @default(cuid())
  userId    String
  surgeryId String
  role      String  @default("STANDARD") // "STANDARD" | "ADMIN"
  // Admin Toolkit module write permission (separate from surgery ADMIN role)
  adminToolkitWrite Boolean @default(false)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  surgery   Surgery @relation("SurgeryUsers", fields: [surgeryId], references: [id], onDelete: Cascade)

  @@unique([userId, surgeryId])
}

// AgeGroup values: 'U5' | 'O5' | 'Adult'

model Surgery {
  id            String   @id @default(cuid())
  name          String   @unique
  slug          String?  @unique // Made optional for backward compatibility
  adminEmail    String?  @unique
  adminPassHash String? // bcrypt hash; nullable until set
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // RBAC relationships
  users        UserSurgery[] @relation("SurgeryUsers")
  defaultUsers User[]        @relation("DefaultSurgery")

  // Clinical governance / sign-off
  requiresClinicalReview Boolean   @default(true)
  lastClinicalReviewAt   DateTime?
  lastClinicalReviewerId String?
  lastClinicalReviewer   User?     @relation("ClinicalReviews", fields: [lastClinicalReviewerId], references: [id])

  // Config
  enableDefaultHighRisk            Boolean                           @default(true) // Enable/disable default high-risk buttons
  enableBuiltInHighlights          Boolean                           @default(true) // Enable/disable built-in highlight rules
  enableImageIcons                 Boolean                           @default(true) // Enable/disable image icons on symptom cards
  uiConfig                         Json?                            // UI configuration (common reasons, etc.)
  highRiskLinks                    HighRiskLink[]
  defaultHighRiskButtons           DefaultHighRiskButtonConfig[]
  highlightRules                   HighlightRule[]
  symptomOverrides                 SurgerySymptomOverride[]
  customSymptoms                   SurgeryCustomSymptom[]
  suggestions                      Suggestion[]
  events                           EngagementEvent[]
  symptomReviews                   SymptomReviewStatus[]
  symptomStatuses                  SurgerySymptomStatus[]
  surgeryFeatureFlags              SurgeryFeatureFlag[]
  appointmentTypes                 AppointmentType[]
  appointmentStaffTypes            AppointmentStaffType[]
  onboardingProfile                SurgeryOnboardingProfile?
  workflowTemplates                WorkflowTemplate[]
  workflowInstances                WorkflowInstance[]
  workflowNodeStyleDefaultsSurgery WorkflowNodeStyleDefaultSurgery[]

  // Admin Toolkit
  adminCategories  AdminCategory[]
  adminItems       AdminItem[]
  adminItemAttachments AdminItemAttachment[]
  adminPinnedPanel AdminPinnedPanel?
  adminDutyRota    AdminDutyRotaEntry[]
  adminOnTakeWeeks AdminOnTakeWeek[]
  adminHistory     AdminHistory[]
}

model BaseSymptom {
  id               String    @id @default(cuid())
  slug             String    @unique
  name             String
  ageGroup         String // 'U5' | 'O5' | 'Adult'
  briefInstruction String?
  highlightedText  String?
  instructions     String? // Legacy markdown field for back-compat
  instructionsJson String? // ProseMirror JSON (canonical format) - stored as string
  instructionsHtml String? // HTML format with colour support
  linkToPage       String?
  variants         Json? // Optional age/scenario-tailored advice variants
  isDeleted        Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lastEditedBy     String? // Editor name
  lastEditedAt     DateTime? // Last edit timestamp

  overrides SurgerySymptomOverride[]
  events    EngagementEvent[]

  // Effective index helpers:
  @@index([name])
  @@index([slug])
  @@index([ageGroup])
  @@index([isDeleted])
}

model SurgerySymptomOverride {
  id               String    @id @default(cuid())
  surgeryId        String
  baseSymptomId    String
  // Any field that, if non-null, overrides the base:
  name             String?
  ageGroup         String? // 'U5' | 'O5' | 'Adult'
  briefInstruction String?
  highlightedText  String?
  instructions     String? // Legacy markdown field for back-compat
  instructionsJson String? // ProseMirror JSON (canonical format) - stored as string
  instructionsHtml String? // HTML format with colour support
  linkToPage       String?
  // Soft delete: if true, this symptom is hidden for this surgery
  isHidden         Boolean   @default(false)
  lastEditedBy     String? // Editor name
  lastEditedAt     DateTime? // Last edit timestamp

  surgery     Surgery     @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  baseSymptom BaseSymptom @relation(fields: [baseSymptomId], references: [id], onDelete: Cascade)

  @@unique([surgeryId, baseSymptomId])
  @@index([surgeryId, baseSymptomId])
}

model SurgeryCustomSymptom {
  id               String    @id @default(cuid())
  surgeryId        String
  slug             String // unique per surgery
  name             String
  ageGroup         String // 'U5' | 'O5' | 'Adult'
  briefInstruction String?
  highlightedText  String?
  instructions     String? // Legacy markdown field for back-compat
  instructionsJson String? // ProseMirror JSON (canonical format) - stored as string
  instructionsHtml String? // HTML format with colour support
  linkToPage       String?
  isDeleted        Boolean   @default(false)
  lastEditedBy     String? // Editor name
  lastEditedAt     DateTime? // Last edit timestamp

  surgery Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@unique([surgeryId, slug])
  @@index([surgeryId, slug])
  @@index([surgeryId, ageGroup])
  @@index([surgeryId, isDeleted])
}

model Suggestion {
  id        String   @id @default(cuid())
  surgeryId String?
  baseId    String? // optional link to the affected base symptom
  symptom   String // captured as user typed/selected
  userEmail String?
  text      String
  // TODO: Add these fields back when database schema is updated
  // status     String   @default("pending") // "pending" | "actioned" | "discarded"
  createdAt DateTime @default(now())
  // updatedAt  DateTime @updatedAt
  surgery   Surgery? @relation(fields: [surgeryId], references: [id])
}

model EngagementEvent {
  id        String   @id @default(cuid())
  surgeryId String?
  baseId    String
  userEmail String?
  event     String // "view_symptom"
  createdAt DateTime @default(now())

  surgery Surgery?    @relation(fields: [surgeryId], references: [id])
  base    BaseSymptom @relation(fields: [baseId], references: [id], onDelete: Cascade)
}

model HighlightRule {
  id        String   @id @default(cuid())
  // If null => global rule (applies to all unless overridden/disabled per surgery later)
  surgeryId String?
  phrase    String
  textColor String   @default("#FFFFFF")
  bgColor   String   @default("#6A0DAD") // purple default
  isEnabled Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  surgery Surgery? @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@unique([surgeryId, phrase])
  @@index([surgeryId, phrase])
}

model HighRiskLink {
  id          String  @id @default(cuid())
  surgeryId   String
  label       String // e.g., "Anaphylaxis", "Stroke"
  // Either link by slug or by id; slug is friendlier for admins:
  symptomSlug String?
  symptomId   String?

  orderIndex Int @default(0)

  surgery Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  // No explicit FK to Base/Custom because it can point to either via slug resolution.

  @@unique([surgeryId, label])
  @@index([surgeryId, orderIndex])
}

model DefaultHighRiskButtonConfig {
  id          String  @id @default(cuid())
  surgeryId   String? // If null, this is a system-wide default button
  buttonKey   String // e.g., "anaphylaxis", "stroke", "chest-pain", "sepsis", "meningitis"
  label       String // e.g., "Anaphylaxis", "Stroke"
  symptomSlug String // e.g., "anaphylaxis", "stroke"
  isEnabled   Boolean @default(true)
  orderIndex  Int     @default(0)

  surgery Surgery? @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@unique([surgeryId, buttonKey])
  @@index([surgeryId, buttonKey])
}

// NextAuth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ImageIcon {
  id              String   @id @default(cuid())
  phrase          String // Phrase to match in briefInstruction
  filePath        String // Path to uploaded image file
  imageUrl        String // URL for serving the image
  alt             String? // Alt text for accessibility
  width           Int? // Image width in pixels
  height          Int? // Image height in pixels
  cardSize        String   @default("medium") // Size on symptom cards: "small", "medium", "large"
  instructionSize String   @default("medium") // Size on instruction pages: "small", "medium", "large"
  isEnabled       Boolean  @default(true) // Enable/disable this icon
  surgeryId       String? // Surgery-specific icon (null = global)
  createdBy       String // Email of superuser who created it
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([phrase, surgeryId])
  @@index([phrase])
  @@index([surgeryId])
}

enum SymptomReviewState {
  PENDING
  APPROVED
  CHANGES_REQUIRED
}

model SymptomReviewStatus {
  id               String             @id @default(cuid())
  surgeryId        String
  surgery          Surgery            @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  symptomId        String // Effective symptom ID (base symptom ID or custom symptom ID)
  ageGroup         String? // e.g. "U5" | "O5" | "Adult" if relevant. Can be null if not age-specific.
  status           SymptomReviewState @default(PENDING)
  lastReviewedAt   DateTime?
  lastReviewedById String?
  lastReviewedBy   User?              @relation(fields: [lastReviewedById], references: [id])
  reviewNote       String?

  @@unique([surgeryId, symptomId, ageGroup])
  @@index([surgeryId])
  @@index([surgeryId, status])
}

model SymptomHistory {
  id                       String   @id @default(cuid())
  symptomId                String // ID of the symptom
  source                   String // 'base' | 'override' | 'custom'
  previousText             String? // Legacy: Previous instructions text (deprecated, use previousInstructionsHtml)
  newText                  String // Legacy: New instructions text (deprecated, use newInstructionsHtml)
  previousBriefInstruction String? // Brief instruction before change
  newBriefInstruction      String? // Brief instruction after change
  previousInstructionsHtml String? // Full instruction HTML before change
  newInstructionsHtml      String? // Full instruction HTML after change
  editorName               String? // Name of the editor
  editorEmail              String? // Email of the editor
  modelUsed                String? // AI model used (if applicable, or "REVERT" for revert operations)
  changedAt                DateTime @default(now())

  @@index([symptomId])
  @@index([source])
  @@index([changedAt])
}

model TokenUsageLog {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  userEmail        String?
  route            String // e.g. "improveInstruction", "explainInstruction"
  modelUsed        String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  estimatedCostUsd Float

  @@index([createdAt])
  @@index([route])
}

model SurgerySymptomStatus {
  id String @id @default(cuid())

  surgeryId     String
  // If this references a global, base symptom that ships with the product:
  baseSymptomId String?

  // If this is a surgery-created symptom that does not exist in the base library:
  customSymptomId String?

  // True if this symptom is available/visible to reception/admins in this surgery.
  isEnabled Boolean @default(true)

  // True if this surgery is currently using its own modified wording
  // instead of the base wording.
  // (For a local-only symptom, this will effectively always be true.)
  isOverridden Boolean @default(false)

  lastEditedAt DateTime? @default(now())
  lastEditedBy String?

  surgery Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  // Ensure we have at most one status row per (surgery, symptom) reference.
  // This enables Prisma upserts like `where: { surgeryId_customSymptomId: { ... } }`.
  @@unique([surgeryId, customSymptomId], name: "surgeryId_customSymptomId")
  @@index([surgeryId])
  @@index([baseSymptomId])
  @@index([customSymptomId])
  @@index([surgeryId, isEnabled])
}

// Feature flags
model Feature {
  id          String   @id @default(cuid())
  key         String   @unique // e.g. "ai_instructions", "ai_training"
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  surgeryFlags SurgeryFeatureFlag[]
  userFlags    UserFeatureFlag[]
}

// Surgery-level feature flag (superuser controls this)
model SurgeryFeatureFlag {
  id        String   @id @default(cuid())
  surgeryId String
  featureId String
  enabled   Boolean  @default(false)
  updatedAt DateTime @default(now())

  surgery Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([surgeryId, featureId])
}

// Per-user override inside a surgery (practice admin controls this, but only if the surgery flag is enabled)
model UserFeatureFlag {
  id        String   @id @default(cuid())
  userId    String
  featureId String
  enabled   Boolean  @default(false)
  updatedAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([userId, featureId])
}

// -----------------------
// Admin Toolkit (per-surgery)
// -----------------------

model AdminCategory {
  id        String   @id @default(cuid())
  surgeryId String
  name      String
  orderIndex Int     @default(0)

  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  surgery Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  items   AdminItem[]
  history AdminHistory[]

  @@index([surgeryId, orderIndex])
  @@index([surgeryId, deletedAt])
}

model AdminItem {
  id         String  @id @default(cuid())
  surgeryId  String
  categoryId String?

  type  String // "PAGE" | "LIST" | "RESPONSIBILITY_TABLE"
  title String

  // PAGE content (stored as HTML to match existing instruction tooling)
  contentHtml String?
  // Optional extra metadata (future-proofing)
  contentJson Json?

  warningLevel   String?
  ownerUserId    String?
  lastReviewedAt DateTime?
  deletedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  surgery   Surgery        @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  category AdminCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  owner    User?           @relation("AdminItemOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  editors     AdminItemEditor[]
  listColumns AdminListColumn[]
  listRows    AdminListRow[]
  attachments AdminItemAttachment[]
  history     AdminHistory[]

  @@index([surgeryId, deletedAt])
  @@index([surgeryId, categoryId])
  @@index([surgeryId, title])
}

model AdminItemEditor {
  id          String   @id @default(cuid())
  adminItemId String
  userId      String
  createdAt   DateTime @default(now())

  adminItem AdminItem @relation(fields: [adminItemId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([adminItemId, userId])
  @@index([userId])
}

model AdminListColumn {
  id          String   @id @default(cuid())
  adminItemId String
  key         String
  label       String
  orderIndex  Int      @default(0)
  type        String   @default("TEXT")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  adminItem AdminItem @relation(fields: [adminItemId], references: [id], onDelete: Cascade)

  @@unique([adminItemId, key])
  @@index([adminItemId, orderIndex])
}

model AdminListRow {
  id          String   @id @default(cuid())
  adminItemId String
  dataJson    Json
  orderIndex  Int      @default(0)

  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  adminItem AdminItem @relation(fields: [adminItemId], references: [id], onDelete: Cascade)

  @@index([adminItemId, orderIndex])
  @@index([adminItemId, deletedAt])
}

model AdminItemAttachment {
  id          String   @id @default(cuid())
  surgeryId   String
  adminItemId String
  label       String
  url         String
  orderIndex  Int      @default(0)

  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  surgery   Surgery  @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  adminItem AdminItem @relation(fields: [adminItemId], references: [id], onDelete: Cascade)

  @@index([adminItemId, orderIndex])
  @@index([surgeryId])
}

model AdminPinnedPanel {
  id String @id @default(cuid())

  surgeryId String @unique
  surgery   Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  taskBuddyText String?
  postRouteText String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdminDutyRotaEntry {
  id String @id @default(cuid())

  surgeryId String
  surgery   Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  // Store date as DateTime; treat as day-level in queries (UTC)
  date DateTime
  name String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([surgeryId, date])
  @@index([surgeryId, date])
}

model AdminOnTakeWeek {
  id String @id @default(cuid())

  surgeryId String
  surgery   Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  // Monday for the week, stored as DATE (Europe/London semantics in app)
  weekCommencing DateTime @db.Date
  gpName         String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([surgeryId, weekCommencing])
  @@index([surgeryId, weekCommencing])
}

model AdminHistory {
  id String @id @default(cuid())

  surgeryId String
  surgery   Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  adminItemId     String?
  adminCategoryId String?

  action      String
  actorUserId String
  diffJson    Json?

  createdAt DateTime @default(now())

  adminItem     AdminItem?     @relation(fields: [adminItemId], references: [id], onDelete: SetNull)
  adminCategory AdminCategory? @relation(fields: [adminCategoryId], references: [id], onDelete: SetNull)
  actorUser     User          @relation("AdminToolkitHistoryActor", fields: [actorUserId], references: [id], onDelete: Restrict)

  @@index([surgeryId, createdAt])
  @@index([adminItemId])
  @@index([adminCategoryId])
}

model AppointmentType {
  id           String    @id @default(cuid())
  surgeryId    String?
  name         String
  staffType    String? // e.g. "PN" | "HCA" | "Dr" | "All"
  durationMins Int?
  colour       String? // hex or tailwind token; optional
  notes        String? // store as text
  isEnabled    Boolean   @default(true)
  isDefault    Boolean   @default(false)
  lastEditedBy String?
  lastEditedAt DateTime? @updatedAt

  Surgery Surgery? @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([surgeryId])
}

model AppointmentStaffType {
  id              String   @id @default(cuid())
  surgeryId       String?
  label           String
  normalizedLabel String
  defaultColour   String?
  orderIndex      Int      @default(0)
  isBuiltIn       Boolean  @default(false)
  isEnabled       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  surgery Surgery? @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@unique([surgeryId, normalizedLabel])
  @@index([surgeryId, orderIndex])
}

model SurgeryOnboardingProfile {
  id        String  @id @default(cuid())
  surgeryId String  @unique
  surgery   Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  profileJson Json // full JSON object of answers
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([surgeryId])
}

// Workflow Engine Models

/// High-level workflow definition, e.g. "Discharge Summary", "Clinic Letter".
model WorkflowTemplate {
  id        String  @id @default(cuid())
  surgeryId String
  surgery   Surgery @relation(fields: [surgeryId], references: [id])

  name            String
  description     String?
  iconKey         String?
  colourHex       String? // optional – to mirror Lucid colours
  isActive        Boolean @default(true)
  landingCategory String  @default("PRIMARY") // "PRIMARY" | "SECONDARY" | "ADMIN" - controls prominence on landing page
  workflowType    String  @default("SUPPORTING") // "PRIMARY" | "SUPPORTING" | "MODULE" - workflow type for landing page hierarchy

  // Global Default inheritance
  sourceTemplateId  String? // Points to global template when this is a surgery override
  sourceTemplate    WorkflowTemplate?  @relation("WorkflowOverrides", fields: [sourceTemplateId], references: [id])
  overrideTemplates WorkflowTemplate[] @relation("WorkflowOverrides")

  // Governance / approval fields
  approvalStatus   String    @default("DRAFT") // "DRAFT" | "APPROVED" | "SUPERSEDED"
  approvedBy       String?
  approvedAt       DateTime?
  approvedByUser   User?     @relation("WorkflowApprovals", fields: [approvedBy], references: [id])
  lastEditedBy     String?
  lastEditedAt     DateTime?
  lastEditedByUser User?     @relation("WorkflowEdits", fields: [lastEditedBy], references: [id])

  nodes           WorkflowNodeTemplate[]
  linkedFromNodes WorkflowNodeLink[]         @relation("LinkedWorkflow")
  instances       WorkflowInstance[]
  styleDefaults   WorkflowNodeStyleDefault[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Individual node in the flowchart – a question, instruction, or end node.
model WorkflowNodeTemplate {
  id         String           @id @default(cuid())
  templateId String
  template   WorkflowTemplate @relation(fields: [templateId], references: [id])

  nodeType  WorkflowNodeType
  title     String
  body      String? // rich instructions / info
  sortOrder Int // for default ordering in editors
  isStart   Boolean          @default(false)

  // Diagram layout position (optional - falls back to vertical layout using sortOrder if not set)
  positionX Int?
  positionY Int?

  // For simple "end" nodes, you can attach an action directly.
  actionKey WorkflowActionKey?

  // Node badges (e.g. "STAMP") - stored as JSON array
  badges Json @default("[]")

  // Node visual styling - stored as JSON object
  // { bgColor?: string, textColor?: string, borderColor?: string, borderWidth?: number, radius?: number, fontWeight?: "normal"|"medium"|"bold", theme?: "default"|"info"|"warning"|"success"|"muted"|"panel" }
  style Json?

  // Linked workflow navigation (Lucid-style) - supports multiple links per node
  workflowLinks WorkflowNodeLink[]

  answerOptions WorkflowAnswerOptionTemplate[]
  answers       WorkflowAnswerRecord[] // instance-time answers linked back here
}

/// Possible answers from a question node, with simple branching.
model WorkflowAnswerOptionTemplate {
  id     String               @id @default(cuid())
  nodeId String
  node   WorkflowNodeTemplate @relation(fields: [nodeId], references: [id])

  label       String // e.g. "Yes", "No", "Ad hoc locum"
  valueKey    String // e.g. "yes", "no", "ad_hoc_locum" (stable key)
  description String? // optional helper text for admins/staff

  // Simple Option-B branching:
  nextNodeId String? // id of next WorkflowNodeTemplate (nullable)
  actionKey  WorkflowActionKey? // outcome if this terminates the workflow

  // Edge routing handles (for orthogonal connections)
  sourceHandle String? // e.g. "source-bottom", "source-right"
  targetHandle String? // e.g. "target-top", "target-left"

  answers WorkflowAnswerRecord[] // all instances that chose this option
}

/// Link from a workflow node to another workflow template (supports multiple links per node).
model WorkflowNodeLink {
  id     String               @id @default(cuid())
  nodeId String
  node   WorkflowNodeTemplate @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  templateId String
  template   WorkflowTemplate @relation("LinkedWorkflow", fields: [templateId], references: [id])

  label String // Display label for the link (e.g. "Open linked workflow", "See referral process")

  sortOrder Int @default(0) // For ordering multiple links

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nodeId])
  @@index([templateId])
}

/// A running instance of a template for a specific document.
model WorkflowInstance {
  id        String  @id @default(cuid())
  surgeryId String
  surgery   Surgery @relation(fields: [surgeryId], references: [id])

  templateId String
  template   WorkflowTemplate @relation(fields: [templateId], references: [id])

  startedById String
  startedBy   User   @relation(fields: [startedById], references: [id])

  status        WorkflowInstanceStatus @default(ACTIVE)
  reference     String? // free text, e.g. "Cardiology 11/12/25 – JS"
  category      String? // e.g. "Hospital Letter", "Result"
  currentNodeId String? // id of current node (no relation for now)

  createdAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  answers WorkflowAnswerRecord[]
}

/// "What did the user pick for this node in this instance?"
model WorkflowAnswerRecord {
  id         String           @id @default(cuid())
  instanceId String
  instance   WorkflowInstance @relation(fields: [instanceId], references: [id])

  nodeTemplateId String
  nodeTemplate   WorkflowNodeTemplate @relation(fields: [nodeTemplateId], references: [id])

  answerOptionId String?
  answerOption   WorkflowAnswerOptionTemplate? @relation(fields: [answerOptionId], references: [id])

  answerValueKey String? // mirrors option.valueKey, or custom value
  freeTextNote   String? // optional comment / note

  createdAt DateTime @default(now())
}

/// Template-level default styling per node type
model WorkflowNodeStyleDefault {
  id         String           @id @default(cuid())
  templateId String
  template   WorkflowTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  nodeType    WorkflowNodeType
  bgColor     String?
  textColor   String?
  borderColor String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, nodeType])
  @@index([templateId])
}

model WorkflowNodeStyleDefaultSurgery {
  id          String           @id @default(cuid())
  surgeryId   String
  nodeType    WorkflowNodeType
  bgColor     String?
  textColor   String?
  borderColor String?

  surgery Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([surgeryId, nodeType])
  @@index([surgeryId])
}

enum WorkflowNodeType {
  INSTRUCTION // info block / "check this list…"
  QUESTION // yes/no or multi-choice
  END // pure end node with actionKey
  PANEL // background container/group node
  REFERENCE // informational reference card (non-connectable)
}

enum WorkflowInstanceStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

/// Actions represent "what should we do with this document?"
/// You can add more over time; existing data will still work.
enum WorkflowActionKey {
  FORWARD_TO_GP
  FORWARD_TO_PRESCRIBING_TEAM
  FORWARD_TO_PHARMACY_TEAM
  FILE_WITHOUT_FORWARDING
  ADD_TO_YELLOW_SLOT
  SEND_STANDARD_LETTER
  CODE_AND_FILE
  OTHER
}
